<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard RVM</title>
  <!-- Pindahkan script QR ke bagian head -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #eef2f7;
      padding: 2em;
    }

    .dashboard {
      background: white;
      padding: 2em;
      max-width: 700px;
      margin: auto;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    h1, h2 {
      color: #333;
    }

    .status {
      background: #f9f9f9;
      padding: 1em;
      border-left: 5px solid #007bff;
      margin-bottom: 1.5em;
      border-radius: 8px;
    }

    .btn {
      padding: 0.7em 1.5em;
      margin: 0.5em;
      font-size: 16px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn:hover {
      background: #218838;
    }

    .btn.disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .points {
      font-size: 24px;
      margin: 1em 0;
    }

    .divider {
      margin: 2em 0;
      border-bottom: 1px solid #ddd;
    }
    .logout-btn {
      background: #dc3545;
      margin-top: 2em;
    }
    .logout-btn:hover {
      background: #c82333;
    }

    .voucher-info {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 8px;
      padding: 1em;
      margin: 1em 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .voucher-count {
      font-size: 20px;
      font-weight: bold;
      color: #856404;
    }

    .voucher-icon {
      font-size: 24px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1em;
      margin: 1em 0;
    }

    .info-card {
      background: #f8f9fa;
      padding: 1em;
      border-radius: 8px;
      text-align: center;
    }

    .info-card .value {
      font-size: 24px;
      font-weight: bold;
      color: #28a745;
    }

    .info-card .label {
      color: #666;
      margin-top: 0.5em;
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <h1>üè≠ Reverse Vending Machine</h1>
    
    <div class="qr-section">
      <h2>QR Code Anda</h2>
      <div id="qrcode"></div>
    </div>

    <div class="status" id="userInfo">
      ID Pengguna: <em>Belum scan QR</em>
    </div>

    <div class="info-grid">
      <div class="info-card">
        <div class="value"><span id="point">0</span></div>
        <div class="label">Total Poin</div>
      </div>
      <div class="info-card">
        <div class="value"><span id="voucher-count">0</span></div>
        <div class="label">Voucher</div>
      </div>
    </div>

    <div class="trash-section">
      <div class="trash-buttons">
        <h2>Pilih Jenis Sampah</h2>
        <button class="btn" onclick="addPoint(10, 'plastic')">üß¥ Plastik (+10)</button>
        <button class="btn" onclick="addPoint(5, 'paper')">üìÑ Kertas (+5)</button>
        <button class="btn" onclick="addPoint(15, 'metal')">üß≤ Logam (+15)</button>
        <button class="btn" onclick="addPoint(20, 'glass')">ü™ü Kaca (+20)</button>
        <button class="btn" onclick="addPoint(30, 'organic')">ü•¨ Organik (+30)</button>
        <button class="btn" onclick="addPoint(50, 'mantan')">üëª Mantan (+50)</button>
      </div>
      
      <!-- <div class="qr-section">
        <h2>QR Code Anda</h2>
        <div id="qrcode"></div>
      </div> -->
    </div>
    <div class="divider"></div>

    <div class="voucher-info">
      <div>
        <div class="voucher-icon">üé´</div>
        <div>Tukarkan 50 poin untuk 1 voucher</div>
      </div>
      <button class="btn disabled" id="voucherBtn" onclick="redeemVoucher()" disabled>üéÅ Tukar Voucher</button>
    </div>

    <button class="btn logout-btn" onclick="logout()">üö™ Keluar</button>
  </div>

  <script>
    let point = 0;
    let vouchers = 0;
    const userId = localStorage.getItem("activeUser");
    const userInfo = document.getElementById("userInfo");

    if (!userId) {
      window.location.href = 'index.html';
    } else {
      userInfo.innerHTML = "ID Pengguna: <strong>" + userId + "</strong>";
      
      // Pastikan elemen qrcode sudah ada sebelum generate
      setTimeout(() => {
        new QRCode(document.getElementById("qrcode"), {
          text: userId,
          width: 128,
          height: 128,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
      }, 100);

      fetch('http://localhost:3000/api/user/scan', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ userId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          point = data.user.points || 0;
          vouchers = data.user.vouchers || 0;
          updateUI();
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert("‚ùå Gagal memuat data pengguna");
      });
    }

    function updateUI() {
      document.getElementById("point").innerText = point;
      document.getElementById("voucher-count").innerText = vouchers;
      const voucherBtn = document.getElementById("voucherBtn");

      if (point >= 50) {
        voucherBtn.disabled = false;
        voucherBtn.classList.remove("disabled");
      } else {
        voucherBtn.disabled = true;
        voucherBtn.classList.add("disabled");
      }
    }

    function addPoint(value, type) {
      if (!userId) {
        alert("‚ùå Harap scan QR terlebih dahulu!");
        return window.location.href = 'index.html';
      }

      // Validasi input
      const validTypes = ['plastic', 'paper', 'metal', 'glass', 'organic', 'mantan'];
      if (!validTypes.includes(type)) {
        alert("‚ùå Tipe sampah tidak valid!");
        return;
      }

      const button = event.target;
      button.disabled = true;
      button.style.opacity = '0.7';

      fetch("http://localhost:3000/api/user/collect", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ userId, type })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          point = data.total;
          updateUI();
          showNotification(`‚ú® Berhasil menambah ${data.pointsAdded} poin!`);
        } else {
          showNotification("‚ùå Gagal: " + data.message, "error");
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification("‚ùå Terjadi kesalahan saat menambah poin", "error");
      })
      .finally(() => {
        button.disabled = false;
        button.style.opacity = '1';
      });
    }


    function redeemVoucher() {
      if (!userId) return window.location.href = 'index.html';
      if (point < 50) return;

      fetch("http://localhost:3000/api/user/redeem", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ userId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          point = data.pointsLeft;
          vouchers = data.vouchers;
          updateUI();
          showNotification('üéâ Voucher berhasil ditukar!');
        } else {
          showNotification("‚ùå Gagal: " + data.message, "error");
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification("‚ùå Terjadi kesalahan saat menukar voucher", "error");
      });
    }
  function logout() {
    if (confirm("Apakah Anda yakin ingin keluar?")) {
      localStorage.removeItem("activeUser");
      window.location.href = 'index.html';
    }
  }
</script>

</body>
</html>
  <style>
    .loading {
      opacity: 0.7;
      cursor: wait !important;
    }
    
    #loadingStatus {
      display: none;
      color: #666;
      font-style: italic;
      margin: 1em 0;
    }
    
    .trash-section {
      display: grid;
      grid-template-columns: 3fr 2fr; /* Ubah rasio grid */
      gap: 2em;
      align-items: start;
      margin: 2em 0; /* Tambah margin */
    }

    .trash-buttons {
      text-align: left;
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* 2 tombol per baris */
      gap: 1em;
    }

    .trash-buttons h2 {
      grid-column: 1 / -1; /* Judul mengambil seluruh lebar */
    }

    .trash-buttons .btn {
      margin: 0; /* Hapus margin default */
      width: 100%; /* Tombol mengambil seluruh lebar */
      display: flex;
      align-items: center;
      justify-content: center;
      height: 3em;
    }

    .qr-section {
      background: #f8f9fa;
      padding: 2em;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 1.5em;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .qr-section h2 {
      margin-top: 0;
      margin-bottom: 1em;
      font-size: 1.2em;
    }

    #qrcode {
      margin: 0 auto;
      padding: 1em;
      background: white;
      border-radius: 8px;
      width: fit-content;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Hapus class trash-section yang lama karena QR sudah dipindah */
    .trash-section {
      margin: 2em 0;
    }

    .trash-buttons {
      text-align: left;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1em;
    }

    .trash-buttons h2 {
      grid-column: 1 / -1; /* Judul mengambil seluruh lebar */
    }

    .trash-buttons .btn {
      margin: 0; /* Hapus margin default */
      width: 100%; /* Tombol mengambil seluruh lebar */
      display: flex;
      align-items: center;
      justify-content: center;
      height: 3em;
    }

    .qr-section {
      background: #f8f9fa;
      padding: 2em;
      border-radius: 8px;
      text-align: center;
      height: fit-content;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .qr-section h2 {
      margin-top: 0;
      margin-bottom: 1em;
      font-size: 1.2em;
    }

    #qrcode {
      margin: 0 auto;
      padding: 1em;
      background: white;
      border-radius: 8px;
      width: fit-content;
    }

    @media (max-width: 768px) {
      .trash-section {
        grid-template-columns: 1fr;
      }
      
      .trash-buttons {
        grid-template-columns: 1fr; /* 1 tombol per baris di mobile */
      }
      
      .qr-section {
        order: -1;
        margin-bottom: 2em;
      }
    }
  </style>
<script>
  let ws;
  
  function connectWebSocket() {
    ws = new WebSocket('ws://localhost:3000');
    
    ws.onopen = () => {
      console.log('Terhubung ke server WebSocket');
    };
    
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      
      if (data.type === 'points_update' && data.userId === userId) {
        point = data.points;
        updateUI();
        showNotification(`‚ú® ${data.added} poin ditambahkan dari ${data.type}!`);
      }
      
      if (data.type === 'voucher_update' && data.userId === userId) {
        point = data.points;
        updateUI();
        showNotification('üéâ Voucher berhasil ditukar!');
      }
    };
    
    ws.onclose = () => {
      console.log('Terputus dari server WebSocket');
      setTimeout(connectWebSocket, 3000); // Reconnect setiap 3 detik
    };
  }

  function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // Update style untuk notifikasi
  const style = document.createElement('style');
  style.textContent = `
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1em 2em;
      border-radius: 8px;
      animation: slideIn 0.5s ease-out;
      z-index: 1000;
      transition: opacity 0.5s ease-out;
    }
    
    .notification.success {
      background: #28a745;
      color: white;
    }
    
    .notification.error {
      background: #dc3545;
      color: white;
    }
    
    .notification.fade-out {
      opacity: 0;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  `;
  document.head.appendChild(style);

  // Hubungkan ke WebSocket saat halaman dimuat
  connectWebSocket();
</script>
  <!-- Hapus script QR yang ada di bawah karena sudah dipindah ke head -->
</body>
</html>
